name: ci

on:
  workflow_run:
    workflows: ["build-dev"]
    types:
      - completed
  push:
    branches:
      - main
    paths:
      - .github/workflows/ci.yml
      - scripts/test/**
      - docker-compose.yml
      - ocypod.toml
      # - 
      # - up.sh
  #     - api/**
  #     - cli/**
  #     # - desktop/**
  #     - runner/**
  #     - server/**
  #     - simulator/**
  #     - graphics/**
  #     - viewer/**
  #     - web/**
  #     - worker_builder/**
  #     - worker_simulator/**

jobs:
  test_do_nothing:
    runs-on: ubuntu-latest
    # services:
      # ctall:
      #   image: ghcr.io/code-tanks/code-tanks-all-dev:latest
      #   ports:
      #     - 8089:8088
      #   volumes:
      #     - /var/run/docker.sock:/var/run/docker.sock
      #   env:
      #     DB_URL: postgres://postgres:postgres@localhost:5432
      #     OCYPOD_URL: localhost:8023
      # registry:
      #   image: registry
      #   ports:
      #     - 5001:5001
      #   env:
      #     REGISTRY_HTTP_ADDR: 0.0.0.0:5001

    steps:
      - uses: actions/checkout@v3
      - name: "up"
        run: docker compose up -d
      - name: "pull dart image"
        run: docker pull dart:stable
      - name: "sleep"
        run: sleep 10
      - name: "ping"
        run: curl -s localhost:8089/ping
      # - name: "setup env"
      #   run: echo "HOST=localhost:8089" > ./scripts/.env
      - name: "test_do_nothing.sh"
        run: ./scripts/test/test_do_nothing.sh
  test_spin_bot:
    runs-on: ubuntu-latest
      - uses: actions/checkout@v3
      - name: "up"
        run: docker compose up -d
      - name: "pull dart image"
        run: docker pull dart:stable
      - name: "sleep"
        run: sleep 10
      - name: "ping"
        run: curl -s localhost:8089/ping
      - name: "test_spin_bot.sh"
        run: ./scripts/test/test_spin_bot.sh

        # run: script -e -c "./scripts/test/test_do_nothing.sh"
  test_timeout:
    runs-on: ubuntu-latest
      - uses: actions/checkout@v3
      - name: "up"
        run: docker compose up -d
      - name: "pull dart image"
        run: docker pull dart:stable
      - name: "sleep"
        run: sleep 10
      - name: "ping"
        run: curl -s localhost:8089/ping
      - name: "test_spin_bot.sh"
        run: ./scripts/test/test_timeout.sh